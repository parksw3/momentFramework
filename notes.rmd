---
title: "Using moment equations to understand heterogeneity"
output: pdf_document
---

## Definition

We want to write $Y_o(v;D)$ for T**y**pe, **o**rder, **v**ariable, and **D**omain.

We define total as follows: $T_o(v;D) = \int v(a)^o D(a) da$. Since we're mainly interested with susceptibility for now, $T_o$ is represents $T_o(.;S)$.

We define $M_i = T_i/T_0$. Then, $M_1$ is the mean susceptibility and $\kappa = \frac{M_2M_0}{M_1^2}-1$ is the squared coefficient of variance (CV).

## SI example

We have $\dot{S}(a) = - \Lambda \sigma(a) S(a)$. Integrating gives us $\dot{T}_0 = - \Lambda T_1$. More generally, we have $\dot{T}_i = - \Lambda T_{i+1}$. Given that $M_1$ is the mean susceptibility, we can also write:

$$
\dot{S} = - \Lambda M_1 S
$$

Using $M$ defined above, we also have the following equations: $\dot{M}_i = - \Lambda (M_{i+1} - M_i M_1)$.

Given that $M_2 = (1 + \kappa) M^2$ and assuming that $\kappa$ stays constant, we can integrate the equation above to obtain the following equation:

$M = \hat{M}S^\kappa$, where $\hat{M}$ is the mean susceptibility of the susceptible population at a disease free equilibrium.

### Idea 1 - $\kappa_i = \frac{M_iM_{i-2}}{M_{i-1}^2}-1$

$$
\begin{aligned}
\dot{\kappa_i} &= \frac{M_{i-2}M_{i-1}\dot{M}_i + M_{i-1}M_i \dot{M}_{i-2} - 2 M_{i-2} M_i \dot{M}_{i-1} }{M_{i-1}^3}\\
&= -\Lambda \frac{M_{i-2}M_{i-1}(M_{i+1} - M_i M_1) + M_{i-1}M_i (M_{i-1} - M_{i-2}M_1) - 2 M_{i-2} M_i (M_i - M_{i-1}M_1) }{M_{i-1}^3}\\
&= -\Lambda \frac{M_{i-2}M_{i-1}M_{i+1} + M_{i-1}^2M_i - 2 M_{i-2}M_i^2}{M_{i-1}^3}\\
&= -\Lambda \frac{M_{i-2} (\kappa_{i+1} + 1)M_i^2 + M_{i-1}^2M_i - 2 M_{i-2}M_i^2}{M_{i-1}^3}\\
&= -\Lambda \frac{(\kappa_{i+1} - 1)M_{i-2} M_i^2 + M_{i-1}^2M_i}{M_{i-1}^3}\\
&=-\Lambda \frac{(\kappa_{i+1} - 1)(\kappa_i +1)M_iM_{i-1}^2 + M_{i-1}^2M_i}{M_{i-1}^3}\\
&=-\Lambda \frac{(\kappa_{i+1}\kappa_i - \kappa_i + \kappa_{i+1})M_i}{M_{i-1}}\\
\end{aligned}
$$

### Idea 2 - $\kappa_i = \frac{M_i}{M_{i-1}M_1}-1$

$$
\begin{aligned}
\dot{\kappa}_i &=\frac{M_{i-1}M_1 \dot{M}_i - M_i M_1 \dot{M}_{i-1} - M_i M_{i-1} \dot{M}_1}{M_{i-1}^2 M_1^2}\\
&=- \Lambda \frac{M_{i-1}M_1 (M_{i+1}-M_iM_1) - M_i M_1 (M_i-M_{i-1}M_1) - M_i M_{i-1} (M_2 - M_1^2) }{M_{i-1}^2 M_1^2}\\
&=- \Lambda \frac{M_{i-1}M_1 M_{i+1} - M_i M_1 M_i - M_i M_{i-1} M_2 + M_i M_{i-1} M_1^2 }{M_{i-1}^2 M_1^2}\\
&=- \Lambda \frac{(\kappa_{i+1}+1) M_i M_{i-1} M_1^2  - M_i M_1 M_i - (\kappa_2 +1) M_i M_{i-1} M_1^2 + M_i M_{i-1} M_1^2 }{M_{i-1}^2 M_1^2}\\
&=- \Lambda \frac{(\kappa_{i+1}+1) M_i M_{i-1} M_1 - (\kappa_i+1) M_{i-1} M_i M_1 - \kappa_2 M_i M_{i-1} M_1}{M_{i-1}^2 M_1}\\
&=- \Lambda \frac{(\kappa_{i+1}+1) M_i - (\kappa_i+1) M_i - \kappa_2 M_i}{M_{i-1}}\\
&=- \Lambda M_i \frac{\kappa_{i+1} - (\kappa_2 +\kappa_i)}{M_{i-1}}\\
&=- \Lambda M_1 (\kappa_i + 1) \{\kappa_{i+1} - (\kappa_2 +\kappa_i)\}\\
\end{aligned}
$$

When $i = 2$, we have $\dot{\kappa} = - \Lambda M (\kappa+1)(\kappa_3 - 2 \kappa)$, where $\kappa = \kappa_2$. For gamma distribution, $\kappa_3 = 2 \kappa$. Let's assume that $r = \kappa_3/\kappa$ stays constant. Then, we have $\dot{\kappa} = - \Lambda M (r-2) (\kappa+1)(\kappa)$. We can do this:

$$
\begin{aligned}
\frac{d\kappa}{dt} &= \frac{d\kappa}{dS}\frac{dS}{dt} \\
- \Lambda M (r-2) (\kappa+1)(\kappa) &= - \Lambda M S \frac{d\kappa}{dS}\\
(r-2) (\kappa+1)(\kappa) &= S \frac{d\kappa}{dS}\\
\frac{(r-2)}{S} &= \frac{1}{\kappa(\kappa+1)} \frac{d\kappa}{dS}\\
\int \frac{(r-2)}{S} dS &= \int \frac{1}{\kappa(\kappa+1)} d\kappa\\
(r-2)\log(S) &= \log(\kappa) - \log(\kappa+1) +C\\
\end{aligned}
$$

We let the initial values $(S(0) , \kappa(0)) = (1,\hat{\kappa})$, then we have $C = \log(\frac{\hat{\kappa}+1}{\hat{\kappa}})$. We can continue with the derivative:

$$
\begin{aligned}
\log(S^{r-2}) &= \log(e^C\frac{\kappa}{\kappa+1})\\
S^{r-2} &= e^C\frac{\kappa}{\kappa+1}\\
S^{r-2}(\kappa+1) &= e^C\kappa\\
S^{r-2} &= (e^C - S^{r-2})\kappa\\
\kappa &= \frac{S^{r-2}}{e^C - S^{r-2}}\\
\end{aligned}
$$

How accurate is this?

```{r load, echo = FALSE, message= FALSE}
load("sim1.rda")
```

### Ex 1 - lognormal distribution

```{r calc, echo = FALSE}
c <- parms.lnorm$N.vec
N.l <- parms.lnorm$N.length
S.mat <- r.lnorm.het[,2:(N.l+1)]
totS <- rowSums(S.mat)
M1 <- rowSums(sweep(S.mat, 2, c, "*"))/rowSums(S.mat)
M2 <- rowSums(sweep(S.mat, 2, c^2, "*"))/rowSums(S.mat)
M3 <- rowSums(sweep(S.mat, 2, c^3, "*"))/rowSums(S.mat)
k2 <- M2/M1^2 -1
k3 <- M3/(M2 * M1) -1
```

#### Comparison of 3 simulations

Linear equation:
$$r \approx (\hat{r}-2)S + 2$$

- Heterogeneous model 
- Approximated model: linear equation for $\kappa_3/\kappa_2$ coupled with approximated equation for $\kappa$
- Approximated model: constant $\kappa$

```{r plotComparison, fig.width = 15, fig.height=5}
source("plotFunctions.R")
baseSim <- list(r.lnorm.het, r.lnorm.app1, r.lnorm.app2)
name <- c("Heterogeneous", "Approximation 1", "Approximation 2")
plotSim(baseSim, name)
```

Linear extrapolation of the $\kappa_3/\kappa_2$ ratio approximates the prevalence trajectory better sice it matches the initial $\kappa$ trajectory but it doesn't approximate $\kappa$ so well near the equilibrium.... How does $r$ vs $S$ look like?

```{r plotR}

plot(cbind(totS, r= k3/k2), type = "l")
lines(cbind(totS,( k3[1]/k2[1] - 2)*totS + 2), col = 2)
```

Can we get some understanding for $\kappa_3/\kappa_2$? Equation for $\dot{\kappa}$ shows us that the equilibrium value of $\kappa^* = \kappa_3/2$ but this might give us something else... Given that $\dot{\kappa}_3 = - \Lambda M (\kappa_3+1)(\kappa_4 - (\kappa_2+\kappa_3))$, we can find the equation for the derivative of $r$:

$$
\begin{aligned}
\dot{r} &= \frac{\dot{\kappa}_3 \kappa - \dot{\kappa} \kappa_3 }{\kappa^2} \\
&= - \Lambda M \frac{(\kappa_3+1)(\kappa_4 - (\kappa+\kappa_3)) \kappa - (\kappa+1)(\kappa_3 - 2 \kappa) \kappa_3}{\kappa^2}\\
&= - \Lambda M \frac{(\kappa_3 \kappa_4 - \kappa\kappa_3 - \kappa_3^2 +\kappa_4 - \kappa - \kappa_3) \kappa - (\kappa \kappa_3 - 2 \kappa^2 + \kappa_3 - 2 \kappa) \kappa_3}{\kappa^2}\\
&= - \Lambda M \frac{( \kappa\kappa_3 \kappa_4 - \kappa^2 \kappa_3 - \kappa \kappa_3^2 + \kappa\kappa_4 - \kappa^2 -  \kappa\kappa_3) - (\kappa \kappa_3^2 - 2 \kappa^2\kappa_3 + \kappa_3^2 - 2 \kappa\kappa_3) }{\kappa^2}\\
&= - \Lambda M \frac{\kappa\kappa_3 \kappa_4 - \kappa^2 \kappa_3 - \kappa \kappa_3^2 + \kappa\kappa_4 - \kappa^2 -  \kappa\kappa_3 - \kappa \kappa_3^2 + 2 \kappa^2\kappa_3 - \kappa_3^2 + 2 \kappa\kappa_3}{\kappa^2}\\
&= - \Lambda M \frac{\kappa\kappa_3 \kappa_4 + \kappa^2 \kappa_3 -2 \kappa \kappa_3^2 + \kappa\kappa_4 - \kappa^2 + \kappa\kappa_3- \kappa_3^2}{\kappa^2}\\
&= - \Lambda M (\kappa_4 r + \kappa_3 - 2 \kappa_3 r + \frac{\kappa_4}{\kappa_3} r - 1 + r - r^2)\\
&= - \Lambda M (\frac{\kappa_4}{\kappa_3} \kappa r^2 + \kappa r - 2 \kappa r^2 + \frac{\kappa_4}{\kappa_3} r - 1 + r - r^2)\\
&= - \Lambda M ((\frac{\kappa_4}{\kappa_3} \kappa - 2\kappa - 1) r^2 +(\frac{\kappa_4}{\kappa_3} + \kappa + 1) r - 1)\\
\end{aligned}
$$

or...we can do this...

$$
\begin{aligned}
\dot{r} &= \frac{\dot{\kappa}_3}{\kappa} - \frac{\dot{\kappa}\kappa_3}{\kappa^2}\\
&= - \Lambda M (\kappa_3 + 1)(\frac{\kappa_4}{\kappa_3}r - (1+r)) + \Lambda M (\kappa + 1)(r - 2) r
\end{aligned}
$$



## SIS example

Here is a simple SIS model: $\dot{S}(a) = \mu(N(a)-S(a)) - \Lambda \sigma(a) S(a)$, where $N(a)$ is the initial distribution of the susceptible individuals in a disease free equilibrium. We are going to define $T_o(N) = T_o(v;N)$. For this model, we have $\dot{T}_i = \mu (T_i(N) - T_i) - \Lambda T_{i+1}$. Using chain rule, we can also get an equation for $M = M_1$:

$$
\begin{aligned}
\dot{M}_i &= \frac{\dot{T}_i}{T_0} - \frac{\dot{T_0} T_i}{T_0^2}\\
&= (\mu (T_i (N)/T_0 -M_i) - \Lambda M_{i+1}) - \mu(M_i T_0 (N)/T_0 - M_i) + \Lambda M_i M_1\\
&= \mu (M_i (N) - M_i) \frac{T_0 (N)}{T_0} - \Lambda (M_{i+1} - M_i M_1)\\
&= \mu (M_i (N) - M_i)/T_0 - \Lambda \kappa_{i+1} M_i M_1\\
\end{aligned}
$$

When $i = 1$, $\dot{M} = \mu (M_1 (N) - M_1)/T_0 - \Lambda \kappa M_1^2$... What can we do with this? 

### Idea 1

I want to know if we can approximate $M_i(N)/M_i$. This term appears in the $\kappa$ equation and maybe we can do something about it:

$$
\begin{aligned}
\frac{d}{dt}(\frac{M_i(N)}{M_i}) &= -\frac{M_i(N)}{M_i^2} \dot{M}_i\\
&= -\frac{M_i(N)}{M_i^2} \{ \mu (M_i (N) - M_i)/T_0 - \Lambda \kappa_{i+1} M_i M_1 \} \\
&= -\frac{M_i(N)}{M_i} \{ \mu (\frac{M_i (N)}{M_i} - 1)/T_0 - \Lambda \kappa_{i+1} M_1 \}\\
\end{aligned}
$$

If we let $i = 1$ and $R = M(N)/M$ and, we have the following equations:

$$\dot{R} = -R \{ \mu (R - 1)/T_0 - \Lambda \kappa M\}$$

We can substitute $M = M(N)/R$:

$$
\begin{aligned}
\dot{R} &= -R \{ \mu (R - 1)/T_0 - \Lambda \kappa M(N)/R\}\\
&= \Lambda \kappa M(N) -R \mu (R - 1)/T_0 \\
\end{aligned}
$$

We also know that since $1/T_0 = \frac{M_1(N)}{RT_1}$. Substituting this gives us

$$
\begin{aligned}
\dot{R} &= \Lambda \kappa M(N) -\mu (R - 1) \frac{M_1(N)}{T_1} \\
&= \Lambda \kappa M(N) -\mu (R - 1) \frac{M(N)}{T_1}\\
&= M(N)(\Lambda \kappa -\mu (R - 1)/T_1)
\end{aligned}
$$

Can we relate this to $\dot{T_0} = \mu (1 - T_0) - \Lambda T_1$?


Can we get some understanding for $\kappa$?

$$
\begin{aligned}
\dot{\kappa}_i &=\frac{M_{i-1}M_1 \dot{M}_i - M_i M_1 \dot{M}_{i-1} - M_i M_{i-1} \dot{M}_1}{M_{i-1}^2 M_1^2}\\
&=\mu \frac{M_{i-1}M_1 (M_i (N) - M_i) - M_i M_1 (M_{i-1} (N) - M_{i-1}) - M_i M_{i-1} (M_1 (N) - M_1)}{M_{i-1}^2 M_1^2 T_0} \\&- \Lambda M_1(\kappa_i + 1)\{\kappa_{i+1} - (\kappa + \kappa_i)\}\\
&=\mu \frac{M_{i-1}M_1 M_i (N) - M_i M_1 M_{i-1} (N) - M_i M_{i-1} M_1 (N) + M_1 M_{i-1} M_i}{M_{i-1}^2 M_1^2 T_0} \\&- \Lambda M_1(\kappa_i + 1)\{\kappa_{i+1} - (\kappa + \kappa_i)\}\\
&=\mu \frac{M_{i-1}M_1 M_i (N) - M_i M_1 M_{i-1} (N) - M_i M_{i-1} M_1 (N)}{M_{i-1}^2 M_1^2 T_0} \\
&+\mu \frac{\kappa_i + 1}{T_0} - \Lambda M_1(\kappa_i + 1)\{\kappa_{i+1} - (\kappa + \kappa_i)\}\\
&=\mu \frac{(\kappa_i (N) + 1) M_{i-1}(N)M_1(N) - (\kappa_i + 1)  M_1 M_{i-1} (N) - (\kappa_i + 1) M_{i-1} M_1 (N)}{M_{i-1} M_1 T_0} \\
&+\mu \frac{\kappa_i + 1}{T_0} - \Lambda M_1(\kappa_i + 1)\{\kappa_{i+1} - (\kappa + \kappa_i)\}\\
&=\mu \frac{(\kappa_i (N) + 1) M_{i-1}(N)M_1(N)}{M_{i-1} M_1 T_0} - \mu \frac{(\kappa_i + 1)M_{i-1} (N)}{M_{i-1} T_0} - \mu \frac{(\kappa_i + 1) M_1 (N)}{M_1 T_0} \\
&+\mu \frac{\kappa_i + 1}{T_0} - \Lambda M_1(\kappa_i + 1)\{\kappa_{i+1} - (\kappa + \kappa_i)\}\\
&=\frac{\mu}{T_0}( \frac{(\kappa_i (N) + 1) M_{i-1}(N)M_1(N)}{M_{i-1} M_1} -\frac{(\kappa_i + 1)M_{i-1} (N)}{M_{i-1}}  - \frac{(\kappa_i + 1) M_1 (N)}{M_1} +\kappa_i + 1)\\
&- \Lambda M_1(\kappa_i + 1)\{\kappa_{i+1} - (\kappa + \kappa_i)\}\\
\end{aligned}
$$

When $i = 2$, we have 

$$
\begin{aligned}
\dot{\kappa}&=\frac{\mu}{T_0}( \frac{(\kappa (N) + 1) M_1(N)^2}{M_1^2} -2\frac{(\kappa + 1)M_1 (N)}{M_1} +\kappa + 1)- \Lambda M_1(\kappa + 1)(\kappa_3 - 2\kappa)\\
&=\frac{\mu}{T_0}( \frac{(\kappa (N) + 1) M_1(N)^2}{M_1^2} -2\frac{(\kappa + 1)M_1 (N)}{M_1} +\kappa + 1)- \Lambda M_1(\kappa + 1)(\kappa_3 - 2\kappa)\\
\end{aligned}
$$

Using $R$ defined above, we have:

$$
\begin{aligned}
\dot{\kappa}&=\frac{\mu}{T_0}((\kappa (N) + 1) R^2 -2(\kappa + 1)R +\kappa + 1)- \Lambda M_1(\kappa + 1)(\kappa_3 - 2\kappa)\\
\end{aligned}
$$

It doesn't seem like this is useful...

### Idea 2

Can we see how accurate $M = \hat{M}T_0^\kappa$ is for SIS model?

$$
\begin{aligned}
\dot{M} &= \frac{dM}{dT_0} \frac{dT_0}{dt}\\
&= \kappa \hat{M} T_0^{\kappa-1} \{ \mu (1 - T_0) - \Lambda T_1\}\\
&= \mu \kappa \hat{M} T_0^{\kappa-1} - \mu\kappa \hat{M} T_0^\kappa - \Lambda \kappa \hat{M} T_0^{\kappa-1} T_1\\
&= \mu \kappa \hat{M} T_0^\kappa /T_0 - \mu\kappa M - \Lambda \kappa \hat{M} T_0^{\kappa-1} M T_0\\
&= \mu  \kappa M/T_0 - \mu\kappa M - \Lambda \kappa M^2\\
&= \mu  (\kappa M - \kappa M T_0)/T_0 - \Lambda \kappa M^2\\
\end{aligned}
$$


### Idea 3

$$
\begin{aligned}
\dot{T} &= \mu (1 - T) - \Lambda T_1\\
\dot{M} &= \mu (M (N) - M)/T - \Lambda \kappa M^2
\end{aligned}
$$

Can we do this?

$$
\begin{aligned}
\frac{dM}{dt} &= \frac{dM}{dT} \frac{dT}{dt} \\
\mu (M (N) - M)/T - \Lambda \kappa M^2 &= (\mu (1 - T) - \Lambda T_1) \frac{dM}{dT}\\
\end{aligned}
$$

Random notes:

$$
\begin{aligned}
M &= T_1/T_0\\
\dot{T}_1 &= \mu (T_1(N) - T_1) - \Lambda T_2\\
\dot{T} &= \mu (1 - T) - \Lambda T_1\\
\end{aligned}
$$

Suppose $\kappa_3$ stays constant. How do we define $\kappa_3$?

$$\kappa_3 + 1 = M_3M_1/M_2^2$$


